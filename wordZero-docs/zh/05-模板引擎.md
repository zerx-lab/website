# 模板引擎

WordZero 包含一个强大的模板引擎，用于生成动态 Word 文档。它支持变量、条件语句、循环和模板继承。

## 概述

模板引擎允许您：
- 定义带占位符的文档模板
- 在运行时替换变量
- 使用条件逻辑来包含/排除内容
- 遍历集合
- 从基础模板继承并覆盖块

## 基本用法

### 创建模板引擎

```go
import "github.com/zerx-lab/wordZero/pkg/document"

// 创建新的模板引擎
engine := document.NewTemplateEngine()
```

### 加载模板

```go
// 从字符串加载模板
templateContent := `
尊敬的 {{customerName}}，

感谢您的订单 #{{orderNumber}}。

此致，
{{companyName}}
`

err := engine.LoadTemplate("order-confirmation", templateContent)
if err != nil {
    log.Fatal(err)
}

// 从文件加载模板
err = engine.LoadTemplateFromFile("invoice", "templates/invoice.txt")
```

### 渲染模板

```go
// 创建模板数据
data := document.NewTemplateData()
data.SetVariable("customerName", "张三")
data.SetVariable("orderNumber", "ORD-12345")
data.SetVariable("companyName", "某某公司")

// 渲染到文档
doc, err := engine.RenderTemplateToDocument("order-confirmation", data)
if err != nil {
    log.Fatal(err)
}

doc.Save("order-confirmation.docx")
```

## 模板语法

### 变量

使用双花括号进行变量替换：

```
你好，{{name}}！
您的订单总额是 {{total}}。
```

```go
data := document.NewTemplateData()
data.SetVariable("name", "小明")
data.SetVariable("total", "¥99.99")
```

### 条件语句

使用 `{{#if}}` 实现条件内容：

```
{{#if isPremiumMember}}
感谢您成为高级会员！
您可以享受所有订单 20% 的折扣。
{{/if}}

{{#if hasDiscount}}
已应用折扣：{{discountAmount}}
{{/if}}
```

```go
data := document.NewTemplateData()
data.SetVariable("isPremiumMember", true)
data.SetVariable("hasDiscount", true)
data.SetVariable("discountAmount", "¥10.00")
```

### Else 条件

```
{{#if inStock}}
商品可立即发货。
{{#else}}
商品目前缺货。
{{/if}}
```

### 循环

使用 `{{#each}}` 遍历列表：

```
订单项目：
{{#each items}}
- {{name}}：{{quantity}} x {{price}}
{{/each}}

总计：{{total}}
```

```go
data := document.NewTemplateData()

// 添加列表项
items := []map[string]interface{}{
    {"name": "商品 A", "quantity": "2", "price": "¥10.00"},
    {"name": "商品 B", "quantity": "1", "price": "¥25.00"},
    {"name": "商品 C", "quantity": "3", "price": "¥5.00"},
}
data.SetList("items", items)
data.SetVariable("total", "¥60.00")
```

### 嵌套循环

```
部门列表：
{{#each departments}}
部门：{{name}}
  员工：
  {{#each employees}}
    - {{firstName}} {{lastName}}
  {{/each}}
{{/each}}
```

## 模板继承

模板继承允许您定义带有可覆盖块的基础模板。

### 定义基础模板

```go
baseTemplate := `
{{companyName}} - 正式文档

{{#block "header"}}
默认页眉
{{/block}}

{{#block "content"}}
默认内容
{{/block}}

{{#block "footer"}}
© {{year}} {{companyName}}。保留所有权利。
{{/block}}
`

engine.LoadTemplate("base", baseTemplate)
```

### 继承模板

```go
reportTemplate := `
{{extends "base"}}

{{#block "header"}}
月度销售报告 - {{month}} {{year}}
{{/block}}

{{#block "content"}}
销售摘要：
{{#each salesData}}
- {{region}}：{{amount}}
{{/each}}

总销售额：{{totalSales}}
{{/block}}
`

engine.LoadTemplate("monthly-report", reportTemplate)
```

### 渲染继承的模板

```go
data := document.NewTemplateData()
data.SetVariable("companyName", "某某公司")
data.SetVariable("month", "一月")
data.SetVariable("year", "2024")
data.SetVariable("totalSales", "¥150,000")

salesData := []map[string]interface{}{
    {"region": "华北", "amount": "¥50,000"},
    {"region": "华南", "amount": "¥45,000"},
    {"region": "华东", "amount": "¥30,000"},
    {"region": "华西", "amount": "¥25,000"},
}
data.SetList("salesData", salesData)

doc, _ := engine.RenderTemplateToDocument("monthly-report", data)
doc.Save("monthly-report.docx")
```

## 图片占位符

模板可以包含图片占位符：

```
公司报告

{{#image companyLogo}}

{{#block "content"}}
报告内容在这里...
{{/block}}
```

```go
data := document.NewTemplateData()
data.SetImage("companyLogo", &document.ImageData{
    Path:   "images/logo.png",
    Width:  200,
    Height: 100,
})
```

## 表格模板

在模板中创建动态表格：

```
发票项目：

| 产品 | 数量 | 单价 | 小计 |
{{#each items}}
| {{product}} | {{qty}} | {{price}} | {{lineTotal}} |
{{/each}}
| | | 合计： | {{grandTotal}} |
```

## 高级功能

### 模板缓存

模板引擎会自动缓存已解析的模板：

```go
// 模板在首次加载后会被缓存
engine.LoadTemplate("report", templateContent)

// 后续渲染使用缓存的模板
doc1, _ := engine.RenderTemplateToDocument("report", data1)
doc2, _ := engine.RenderTemplateToDocument("report", data2)

// 如果需要，清除缓存
engine.ClearCache()
```

### 线程安全

模板引擎支持并发渲染，是线程安全的：

```go
// 可以安全地从多个 goroutine 使用
var wg sync.WaitGroup
for i := 0; i < 10; i++ {
    wg.Add(1)
    go func(id int) {
        defer wg.Done()
        data := document.NewTemplateData()
        data.SetVariable("id", fmt.Sprintf("%d", id))
        doc, _ := engine.RenderTemplateToDocument("report", data)
        doc.Save(fmt.Sprintf("report-%d.docx", id))
    }(i)
}
wg.Wait()
```

### 自定义模板函数

```go
// 注册自定义函数
engine.RegisterFunction("formatCurrency", func(value interface{}) string {
    if v, ok := value.(float64); ok {
        return fmt.Sprintf("¥%.2f", v)
    }
    return fmt.Sprintf("%v", value)
})

// 在模板中使用
// 总计：{{formatCurrency total}}
```

## 完整示例

```go
package main

import (
    "log"
    "github.com/zerx-lab/wordZero/pkg/document"
)

func main() {
    engine := document.NewTemplateEngine()

    // 定义发票模板
    invoiceTemplate := `
发票

{{companyName}}
{{companyAddress}}

收款方：
{{customerName}}
{{customerAddress}}

发票编号：{{invoiceNumber}}
日期：{{invoiceDate}}
到期日：{{dueDate}}

项目：
{{#each items}}
{{description}}
  数量：{{quantity}} x {{unitPrice}} = {{lineTotal}}
{{/each}}

小计：{{subtotal}}
{{#if hasTax}}
税费（{{taxRate}}%）：{{taxAmount}}
{{/if}}
{{#if hasDiscount}}
折扣：-{{discountAmount}}
{{/if}}

应付总额：{{grandTotal}}

{{#if notes}}
备注：{{notes}}
{{/if}}

感谢您的惠顾！
`

    engine.LoadTemplate("invoice", invoiceTemplate)

    // 准备数据
    data := document.NewTemplateData()
    data.SetVariable("companyName", "某某公司")
    data.SetVariable("companyAddress", "北京市朝阳区商业大道123号")
    data.SetVariable("customerName", "李四")
    data.SetVariable("customerAddress", "上海市浦东新区客户街456号")
    data.SetVariable("invoiceNumber", "INV-2024-001")
    data.SetVariable("invoiceDate", "2024年1月15日")
    data.SetVariable("dueDate", "2024年2月15日")

    items := []map[string]interface{}{
        {
            "description": "专业服务",
            "quantity":    "10小时",
            "unitPrice":   "¥150.00",
            "lineTotal":   "¥1,500.00",
        },
        {
            "description": "软件许可",
            "quantity":    "1",
            "unitPrice":   "¥500.00",
            "lineTotal":   "¥500.00",
        },
    }
    data.SetList("items", items)

    data.SetVariable("subtotal", "¥2,000.00")
    data.SetVariable("hasTax", true)
    data.SetVariable("taxRate", "10")
    data.SetVariable("taxAmount", "¥200.00")
    data.SetVariable("hasDiscount", false)
    data.SetVariable("grandTotal", "¥2,200.00")
    data.SetVariable("notes", "请在30天内付款。")

    // 渲染并保存
    doc, err := engine.RenderTemplateToDocument("invoice", data)
    if err != nil {
        log.Fatal(err)
    }

    if err := doc.Save("invoice.docx"); err != nil {
        log.Fatal(err)
    }
}
```

## 最佳实践

1. **保持模板简单** - 复杂的逻辑应该放在 Go 代码中，而不是模板中。

2. **使用有意义的变量名** - `{{customerFirstName}}` 比 `{{n1}}` 更好。

3. **渲染前验证数据** - 确保所有必需的变量都已设置。

4. **使用模板继承** - 创建基础模板以保持品牌一致性。

5. **缓存模板** - 加载一次模板，多次渲染时复用。

6. **优雅处理缺失变量** - 在适当的地方提供默认值。

```go
// 良好做法：设置默认值
if customer.Name == "" {
    data.SetVariable("customerName", "尊贵的客户")
} else {
    data.SetVariable("customerName", customer.Name)
}
```
